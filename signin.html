<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign In</title>
    <link rel="stylesheet" href="login.css" />
    <script type="text/javascript" src="validation.js" defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </head>
  <body>
    <div class="wrapper">
      <h1>Sign In</h1>
      <p id="error-message" style="color: red"></p>
      <p id="login-success-message" style="color: green"></p>
  <!-- Google reCAPTCHA script -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <!-- Google Sign-In script -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    .g_id_signin {
      pointer-events: none;
      opacity: 0.5;
      transform: scale(1.5);
    }
    .g-recaptcha {
      transform: scale(0.75); /* Scales down the widget */
      transform-origin: 0 0; /* Keeps the widget aligned */
      position: fixed;
      left: 80px; /* distance from the left side */
      bottom: 40px; /* distance from the bottom, adjust as needed */
      z-index: 9999; /* make sure it's on top of other elements */
    }
  </style>
</head>

<body>
  <!-- Google Sign-In Button -->
  <div id="g_id_onload" data-client_id="854962203059-i2ndi0smttouaa0a5au5kl3n729nd8d0.apps.googleusercontent.com" data-callback="handleCredentialResponse"></div>
  <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>

  <!-- Google reCAPTCHA -->
  <div class="g-recaptcha" data-sitekey="6Le0kxUrAAAAAGO-ri38-Km2lpyXMaCew6w0BsKP" data-callback="enableLogin"></div>

  <!-- Success and Error Message -->
  <div id="login-success-message"></div>
  <div id="error-message" style="color: red;"></div>

  <script>
    // This function is triggered after CAPTCHA is completed
    function enableLogin() {
      // Enable the Google Sign-In button after CAPTCHA completion
      document.querySelector(".g_id_signin").style.pointerEvents = "auto";
      document.querySelector(".g_id_signin").style.opacity = "1";
    }

    // Google Sign-In handler
    function handleCredentialResponse(response) {
      const data = parseJwt(response.credential);
      console.log("Google user:", data);

      // After a successful login:
      localStorage.setItem("userName", data.name || data.email);
      window.location.href = "dashboard.html";  // Redirect to your dashboard

      // Update login success message on the page
      document.getElementById("login-success-message").textContent = `Welcome to Synergy Fit, ${data.name || data.email}.`;
      document.getElementById("error-message").textContent = "";

      // Show a browser notification
      if (Notification.permission === "granted") {
        new Notification("Welcome to Synergy Fit ðŸ’ª", {
          body: `Hey ${data.name || data.email}, let's crush those fitness goals!`,
          icon: "https://example.com/logo.png",  // optional: your gym logo
        });
      } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then((permission) => {
          if (permission === "granted") {
            new Notification("Welcome to Synergy Fit ðŸ’ª", {
              body: `Hey ${data.name || data.email}, let's crush those fitness goals!`,
              icon: "https://example.com/logo.png",
            });
          }
        });
      }
    }

    // Function to decode JWT token (Google Sign-In)
    function parseJwt(token) {
      var base64Url = token.split('.')[1];
      var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));

      return JSON.parse(jsonPayload);
    }

    </script>
  </body>
</html>
